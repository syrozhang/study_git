/**************************************************************************
 *                                                                        *
 *         Copyright (c) 2002 by Sunplus Technology Co., Ltd.             *
 *                                                                        *
 *  This software is copyrighted by and is the property of Sunplus        *
 *  Technology Co., Ltd. All rights are reserved by Sunplus Technology    *
 *  Co., Ltd. This software may only be used in accordance with the       *
 *  corresponding license agreement. Any unauthorized use, duplication,   *
 *  distribution, or disclosure of this software is expressly forbidden.  *
 *                                                                        *
 *  This Copyright notice MUST not be removed or modified without prior   *
 *  written consent of Sunplus Technology Co., Ltd.                       *
 *                                                                        *
 *  Sunplus Technology Co., Ltd. reserves the right to modify this        *
 *  software without notice.                                              *
 *                                                                        *
 *  Sunplus Technology Co., Ltd.                                          *
 *  19, Innovation First Road, Science-Based Industrial Park,             *
 *  Hsin-Chu, Taiwan, R.O.C.                                              *
 *                                                                        *
 *  Author:                                                               *
 *                                                                        *
 **************************************************************************/
#include "general.h"
#include "hw_front.h"
#include "hw_cdsp.h"
#include "hw_cpu.h"
#include "stdio.h"
#include "device.h"
#include "aaa_api.h"
#include "tv_ov.h"

#if 0
#define CCIR_601
#endif

void
i2cWriteTab(
	UINT8 *tab
)
{
	UINT32 i;
	UINT32 tab0, tab1;

	i = 0;
	while ( (tab[i] + tab[i + 1]) != 0x1fe ) {
		tab0 = tab[i];
		tab1 = tab[i + 1];
		hwFrontSscWrite(&tab0, &tab1, 0x01, 0x00);
		i += 2;
	}
}

UINT8 SP512_NTSC_CVBS_tab[] = {
	0x00,0x00,  /* set ntsc format */
	0x03,0x00,
	0x01,0x09,  /* pedestal */
	0x0c,0x8a,  /* cagc target = 138 */
	0x82,0x42,  /* comb_wide_band = 0 */
	0x30,0x22,  /* vactive_start */
	0x31,0x61,  /* vactive_height */
	0x07,0x00,  /* YC swap */
	0x85,0x0a,
	0x86,0x03,
	0x87,0x08,
	0x90,0x08,  /* enable ADC, choose yin0 */
	0x92,0x0b,  /* choose gate-clock format */
	0x94,0x30,  /* choose all-digital AGC */
	0x90,0x28,  /* enable DC restore */
	0x02,0x5f,
	0x80,0x13,  /* turn on peaking filter */
	0x0a,0x80,  /* control saturation */
	0x07,0x24,  /* align y and c */
	0x18,0x21,  /* cdto setting */
	0x19,0xf0,
	0x1a,0x7c,
	0x1b,0x1f,
	0x2e,0x8e,  /* set hoffset */
	0x93,0x30,  /* Auto NTSC/PAL */
	0x95,0x02,  /* Auto NTSC/PAL */
	0x3f,0x00,
	0xff,0xff
};

UINT8 SP512_NTSC_CVBS_CCIR656_tab[] = {
	0x00,0x11,
	0x01,0x06,
	0x02,0xc2,
	0x03,0x00,
	0x04,0x00,
	0x05,0x00,
	0x06,0xab,
	0x07,0xc0,
	0x08,0x88,
	0x09,0x08,
	0x0a,0x80,
	0x0b,0x47,		//yyq  ???
//	0x0b,0x38,
//	0x0c,0x40,		//yyq  ???
	0x0c,0x56,	
	0x0d,0x00,
	0x0e,0x08,
	0x0f,0x2b,
	0x10,64,/*0x48,*/
	0x11,0x0c,
	0x12,0x01,
	0x13,0x03,
	0x14,0x00,
	0x15,0x00,
	0x16,0x00,
	0x17,0x00,
	0x18,0x00,
	0x19,0x00,
	0x1a,0x00,
	0x1d,0x00,
	0x1e,0x00,
	0x1f,0xa5,
	0x40,0x22,
	0x41,0xff,
	0x42,0xff,
	0x43,0xff,
	0x44,0xff,
	0x45,0xff,
	0x46,0xff,
	0x47,0xff,
	0x48,0xff,
	0x49,0xff,
	0x4a,0xff,
	0x4b,0xff,
	0x4c,0xff,
	0x4d,0xff,
	0x4e,0xff,
	0x4f,0xff,
	0x50,0xff,
	0x51,0xff,
	0x52,0xff,
	0x53,0xff,
	0x54,0xff,
	0x55,0xff,
	0x56,0xff,
	0x57,0xff,
	0x58,0x00,
	0x59,0x5b,
	0x5a,0x17,
	0x5b,0x13,/*0x03,*/
	0x5c,0x00,
	0x5d,0x00,
	0x5e,0x00,
	0x60,0x00,
	0x61,0x2c,
	0x62,0x2f,
	0xff,0xff
#if 0
	0x00,0x00,  /* set ntsc format */
	0x03,0x00,
	0x01,0x09,  /* pedestal */
	0x0c,0x8a,  /* cagc target = 138 */
	0x82,0x42,  /* comb_wide_band = 0 */
	0x30,0x22,  /* vactive_start */
	0x31,0x61,  /* vactive_height */
	0x07,0x00,  /* YC swap */
	0x85,0x0a,
	0x86,0x03,
	0x87,0x08,
	0x90,0x08,  /* enable ADC, choose yin0 */
	0x92,0x0c,  /* choose gate-clock format */
	0x94,0x30,  /* choose all-digital AGC */
	0x90,0x28,  /* enable DC restore */
	0x02,0x5f,
	0x80,0x13,  /* turn on peaking filter */
	0x0a,0x80,  /* control saturation */
	0x07,0x24,  /* align y and c */
	0x18,0x21,  /* cdto setting */
	0x19,0xf0,
	0x1a,0x7c,
	0x1b,0x1f,
	0x2e,0x8e,  /* set hoffset */
	0x93,0x30,  /* Auto NTSC/PAL */
	0x95,0x02,  /* Auto NTSC/PAL */
	0x3f,0x00,
	0xff,0xff
#endif
};

#if 0
UINT8 SP512_NTSC_CVBS_tab[] = {
	0x00,0x00, 0x01,0x08, 0x02,0x5F, 0x03,0x00,
	0x04,0xDD, 0x05,0x32, 0x06,0x0A, 0x07,0x21,
	0x08,0x80, 0x09,0x20, 0x0A,0x80, 0x0B,0x00,
	0x0C,0x67, 0x0D,0x04, 0x0F,0x0C,
	0x10,0x0A, 0x11,0xB9, 0x12,0x06, 0x13,0x82,
	0x14,0x40, 0x15,0x64, 0x16,0x74, 0x17,0xCB,
	0x18,0x21, 0x19,0xF0, 0x1A,0x7C, 0x1B,0x1F,
	0x1C,0x20, 0x1D,0x00, 0x1E,0x00, 0x1F,0x00,
	0x20,0x3E, 0x21,0x3E, 0x22,0x00, 0x23,0x80,
	0x24,0xE9, 0x25,0x0F, 0x26,0x2D, 0x27,0x50,
	0x28,0x22, 0x29,0x4E, 0x2A,0xD6, 0x2B,0x4E,
	0x2C,0x23, 0x2D,0x64, 0x2E,0x82, 0x2F,0x50,
	0x30,0x22, 0x31,0x61, 0x32,0x70, 0x33,0x0E,
	0x34,0x6C, 0x35,0x90, 0x36,0x70, 0x37,0x0E,
	0x38,0x80, 0x39,0x0A, 0x3A,0x0E, 0x3B,0x00,
	#if 0 /* 1104 */
	0x3C,0x05, 0x3D,0x00, 0x3E,0x00, 0x3F,0x00,
	#else
	0x3C,0x05, 0x3D,0x00, 0x3E,0x00,
	#endif
	0x78,0x40, 0x79,0xDE, 0x7A,0x7A, 0x7B,0x00,
	0x7C,0xEC, 0x7D,0xFA, 0x7E,0xFF, 0x7F,0x00,
	0x80,0x05,
	0x81,0x7F, 0x82,0x42, 0x83,0x6F, 0x84,0x0A,
	0x85,0x0A, 0x86,0x03, 0x87,0x08,
	#if 0 /* 1104 */
	0x90,0x00, 0x91,0x7A, 0x92,0x0c, 0x93,0x00,
	#else
	0x90,0x00, 0x91,0x7A, 0x92,0x0c, 0x93,0x30,
	#endif
	#if 0 /* 1104 */
	0x94,0x30, 0x95,0x3d, 0x90,0x20,
	#else
	0x94,0x30, 0x95,0x02, 0x90,0x20,
	#endif
	#if 1 /* 1104 */
	0x3F,0x00,
	#endif
	0xff,0xff
};
#endif

UINT8 SP512_PAL_CVBS_tab[] = {
	0x00,0x32, 0x01,0x08, 0x02,0x5F, 0x03,0x06,
	0x05,0x32, 0x06,0x0A, 0x07,0x21,
	0x08,0x80, 0x09,0x20, 0x0A,0xb0, 0x0B,0x00,
	0x0C,0x67, 0x0D,0x04, 0x0F,0x0C,
	0x10,0x0A, 0x11,0xB9, 0x12,0x06, 0x13,0x82,
	0x14,0x40, 0x15,0x64, 0x16,0x74, 0x17,0xCB,
	0x18,0x2A, 0x19,0x09, 0x1A,0x8A, 0x1B,0xCB,
	0x1C,0x20, 0x1D,0x00, 0x1E,0x00, 0x1F,0x00,
	0x20,0x3E, 0x21,0x3E, 0x22,0x00, 0x23,0x80,
	0x24,0xE9, 0x25,0x0F, 0x26,0x2D, 0x27,0x50,
	0x28,0x22, 0x29,0x4E, 0x2A,0xD6, 0x2B,0x4E,
	0x2C,0x23, 0x2D,0x64, 0x2E,0x82, 0x2F,0x50,
	0x30,0x2A, 0x31,0xC1, 0x32,0x70, 0x33,0x0E,
	0x34,0x6C, 0x35,0x90, 0x36,0x70, 0x37,0x0E,
	0x38,0x80, 0x39,0x0A, 0x3A,0x0E, 0x3B,0x00,
	0x3C,0x05, 0x3D,0x00, 0x3E,0x00, 0x3F,0x00,
	0x78,0x40, 0x79,0xDE, 0x7A,0x7A, 0x7B,0x00,
	0x7C,0xEC, 0x7D,0xFA, 0x7E,0xFF, 0x7F,0x00,
	0x80,0x05,
	0x81,0x7F, 0x82,0x46, 0x83,0x6F,
	0x85,0x0A, 0x86,0x03, 0x87,0x08,
	0x90,0x00, 0x91,0x7A, 0x92,0x0c, 0x93,0x00,
	0x94,0x30, 0x95,0x38, 0x90,0x28,
	0xff,0xff
};

extern UINT32 MAXVSIZEM_NOW;

void saa7113Init(UINT32 mode)
{
#if 1
	UINT32 reg_addr[1], reg_data[1];
	UINT32 sys ;
	
	i2cWriteTab(SP512_NTSC_CVBS_CCIR656_tab);
	/*hwFrontVValidWait(0, 3);  	  */
	hwWait(0, 400);
	hwFrontSscRead(0x1f,&sys,0x01,0x02);
	if(sys == 0xff)
	{
		printf("saa7113 error !\n") ;
		hwTvSensorModeSel(0) ;
		osTimeDly(20);
		hwTvSensorModeSel(1) ;
		return;
	}
	sys &= 0x20;
	if(sys)
	{
		printf("NTSC init OK!\n");
        MAXVSIZEM_NOW = 244;
		/*WRITE8(0xb0002068,0x72);	For NTSC*/
		hwCdspHscaleYUVSet(720, 320);
        hwCdspVscaleSet(244, 244);
	}
	else
	{
		printf("PAL init OK!\n");
		MAXVSIZEM_NOW = 288;
		/*WRITE8(0xb0002068,0x70);	 For pal*/
		hwCdspHscaleYUVSet(720, 320);
		hwCdspVscaleSet(288, 242);

	 }
#else
	UINT32 reg_addr[1], reg_data[1];
    switch ( mode ) {
		case 0x00: /* NTSC */
		#ifdef CCIR_601
		i2cWriteTab(SP512_NTSC_CVBS_tab);
		#else
		i2cWriteTab(SP512_NTSC_CVBS_CCIR656_tab);
		#endif

		WRITE8(0xb0002068,0x72);	/*For NTSC*/
		hwCdspHscaleYUVSet(720, 320);
    	hwCdspVscaleSet(243, 240);
		printf("NTSC init OK!\n");

		break;
	case 0x01: /* PAL */
		i2cWriteTab(SP512_NTSC_CVBS_CCIR656_tab);
		WRITE8(0xb0002068,0x70);	/*For PAL*/
		hwCdspHscaleYUVSet(720, 320);
    	hwCdspVscaleSet(288, 240);
    	printf("PAL init OK!\n");

		break;
	#if 0
	case 0x00: /* NTSC */

		#ifdef CCIR_601
		i2cWriteTab(SP512_NTSC_CVBS_tab);
		#else
		i2cWriteTab(SP512_NTSC_CVBS_CCIR656_tab);
		#endif
		#if 0
		reg_addr[0]= 0x00;
		reg_data[0]= 0x01;
		hwFrontSscWrite(reg_addr, reg_data, 0x01, 0x00);
		reg_addr[0]= 0x03;
		reg_data[0]= 0x03;
		hwFrontSscWrite(reg_addr, reg_data, 0x01, 0x00);
		reg_addr[0]= 0x07;
		reg_data[0]= 0x24;
		hwFrontSscWrite(reg_addr, reg_data, 0x01, 0x00);
		reg_addr[0]= 0x90;
		reg_data[0]= 0x14;
		hwFrontSscWrite(reg_addr, reg_data, 0x01, 0x00);
		reg_addr[0]= 0x92;
		reg_data[0]= 0x0B;	/* 0x0c: 656, 0x0b: 601 */
		hwFrontSscWrite(reg_addr, reg_data, 0x01, 0x00);
		reg_addr[0]= 0x94;
		reg_data[0]= 0x30;
		hwFrontSscWrite(reg_addr, reg_data, 0x01, 0x00);
		reg_addr[0]= 0x90;
		reg_data[0]= 0x28; /* 0x34: S-video */
		hwFrontSscWrite(reg_addr, reg_data, 0x01, 0x00);
		#endif
		break;
	case 0x01: /* PAL */
		i2cWriteTab(SP512_PAL_CVBS_tab);
		reg_addr[0]= 0x00;
		reg_data[0]= 0x33;
		hwFrontSscWrite(reg_addr, reg_data, 0x01, 0x00);
		reg_addr[0]= 0x03;
		reg_data[0]= 0x00;
		hwFrontSscWrite(reg_addr, reg_data, 0x01, 0x00);
		reg_addr[0]= 0x07;
		reg_data[0]= 0x24;
		hwFrontSscWrite(reg_addr, reg_data, 0x01, 0x00);
		reg_addr[0]= 0x90;
		reg_data[0]= 0x14;
		hwFrontSscWrite(reg_addr, reg_data, 0x01, 0x00);
		reg_addr[0]= 0x92;
		reg_data[0]= 0x0C;
		hwFrontSscWrite(reg_addr, reg_data, 0x01, 0x00);
		reg_addr[0]= 0x94;
		reg_data[0]= 0x30;
		hwFrontSscWrite(reg_addr, reg_data, 0x01, 0x00);
		reg_addr[0]= 0x90;
		reg_data[0]= 0x34;
		hwFrontSscWrite(reg_addr, reg_data, 0x01, 0x00);
		break;
	#endif
	default:
		break;
	}
#endif
}
